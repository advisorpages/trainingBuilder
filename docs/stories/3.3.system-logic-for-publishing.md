# Story 3.3: System Logic for Publishing

## Status
Completed

## Story
**As a** Content Developer,
**I want** the system to handle publishing logic automatically where appropriate,
**so that** sessions follow consistent rules and I don't have to manually manage every lifecycle transition.

## Story Context

**Existing System Integration:**

- Integrates with: Manual status updates (Story 3.2), session status display (Story 3.1), session management (Epic 2)
- Technology: NestJS backend with scheduled tasks, business rule engine, automated workflow processing
- Follows pattern: Background job processing and automated system workflows
- Touch points: Session lifecycle management, automated notifications, business rule enforcement, data consistency

## Acceptance Criteria

**Automated Workflow Requirements:**

1. System automatically marks sessions as "Completed" after their end time has passed
2. System enforces business rules for status transitions at the database level
3. System prevents conflicting status changes through optimistic locking or transactions
4. System provides automated content validation before allowing publication
5. System handles timezone considerations for session scheduling and completion
6. System logs all automated status changes for audit purposes

**Business Rule Enforcement:**

7. System prevents publication of sessions with incomplete required content
8. System enforces minimum lead time before session start for publication
9. System handles session conflicts and scheduling validation
10. System maintains data consistency during status transitions
11. System provides rollback mechanisms for failed automated operations

**Integration Requirements:**

12. Automated logic integrates seamlessly with manual status updates
13. System provides clear feedback when automated rules prevent user actions
14. Automated workflows respect user permissions and authorization
15. System maintains performance with large numbers of sessions and frequent updates

## Technical Notes

- **Integration Approach:** Implement background services and scheduled tasks with comprehensive business rule validation
- **Existing Pattern Reference:** Follow background job patterns and automated workflow systems
- **Key Constraints:** Must be reliable, performant, and maintainable while handling complex business logic

## Definition of Done

- [x] Automated session completion after end time implemented with timezone handling
- [x] Comprehensive business rule validation system implemented
- [x] Automated content validation before publication working
- [x] Database-level constraints and transaction handling implemented
- [x] Automated status change logging and audit trail functional
- [x] Performance optimized for large-scale automated processing

## Tasks / Subtasks

- [ ] Task 1: Automated Session Completion (AC: 1, 5, 6)
  - [ ] Implement scheduled job to check for sessions past end time
  - [ ] Add timezone-aware session completion logic
  - [ ] Create automated status transition from Published to Completed
  - [ ] Add logging and audit trail for automated completions
  - [ ] Handle edge cases and error scenarios for completion

- [ ] Task 2: Business Rule Engine (AC: 2, 7, 8, 10)
  - [ ] Create comprehensive business rule validation system
  - [ ] Implement content completeness validation
  - [ ] Add session scheduling and conflict validation
  - [ ] Create publication lead time enforcement
  - [ ] Add database-level constraints for data integrity

- [ ] Task 3: Transaction and Concurrency Management (AC: 3, 11)
  - [ ] Implement optimistic locking for status changes
  - [ ] Add transaction management for complex status transitions
  - [ ] Create rollback mechanisms for failed operations
  - [ ] Handle concurrent status change attempts
  - [ ] Add deadlock detection and recovery

- [ ] Task 4: Automated Content Validation (AC: 4, 7, 13)
  - [ ] Create automated content validation service
  - [ ] Implement validation rules for required session content
  - [ ] Add promotional content completeness checking
  - [ ] Create validation feedback and error reporting
  - [ ] Integrate with publishing workflow validation

- [ ] Task 5: System Integration and Performance (AC: 9, 12, 14, 15)
  - [ ] Integrate automated logic with manual status update system
  - [ ] Add session conflict detection and resolution
  - [ ] Implement efficient background processing for large datasets
  - [ ] Add monitoring and alerting for automated workflows
  - [ ] Test system performance with high session volumes

## Dev Notes

### Project Structure Context
[Source: docs/architecture.md#2-project-structure-monorepo]

**Implementation Location:**
- Backend logic: `packages/backend/src/modules/sessions/`
- Shared types: `packages/shared/src/types/`
- Background services: `packages/backend/src/services/`
- Scheduled tasks: `packages/backend/src/modules/sessions/schedulers/`

**Database Integration:**
- PostgreSQL connection via NestJS TypeORM
- Sessions table with status field (enum: draft, published, completed, cancelled)
- Audit trail tables for status change tracking
- Background job queue tables for task management

### Technical Architecture Details
[Source: docs/architecture.md#1-high-level-architecture]

**Technology Stack:**
- **Backend Framework:** NestJS with TypeScript
- **Database:** PostgreSQL with existing brownfield schema extension
- **Job Processing:** NestJS built-in schedulers with @Cron decorators
- **Authentication:** JWT-based with role permissions
- **Deployment:** Docker containers in monorepo structure

**API Endpoints Required:**
- `PATCH /admin/sessions/{id}/status` - Manual status updates (integrates with Story 3.2)
- `GET /admin/sessions/validation/{id}` - Content validation status
- Background cron jobs (no public endpoints)

### Database Schema Extensions
[Source: docs/architecture.md#3-database-schema]

**Sessions Table Extensions:**
```sql
-- Existing: id, title, description, start_time, end_time, status, qr_code_url, author_id, location_id, trainer_id
-- Add: status_changed_at, status_changed_by, automated_status_change, content_validation_status, content_validation_errors, publication_requirements_met, last_validation_check
```

**New Audit Table:**
```sql
CREATE TABLE session_status_history (
  id SERIAL PRIMARY KEY,
  session_id INT REFERENCES sessions(id),
  old_status VARCHAR(20),
  new_status VARCHAR(20),
  changed_by INT REFERENCES users(id),
  automated_change BOOLEAN DEFAULT false,
  change_reason TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Automated Workflow Design
[Source: Epic 3 publishing requirements and system automation needs]

**Scheduled Tasks Implementation:**
- `@Cron('0 */15 * * * *')` Session completion checker (every 15 minutes)
- `@Cron('0 0 2 * * *')` Content validation auditor (daily at 2 AM)
- `@Cron('0 0 3 * * *')` Data consistency checker (daily at 3 AM)
- `@Cron('0 0 * * * *')` Performance metrics collection (hourly)

**Business Rules Implementation:**
- Session must have all required fields before publication
- Session must be at least 24 hours in future when published
- Session cannot conflict with existing published sessions
- Content must pass validation checklist before publication

**Timezone Handling:**
- Store all session times in UTC in database
- Convert to local timezone for display and validation
- Handle daylight saving time transitions
- Support multiple timezone requirements

### NestJS Module Structure
[Source: docs/architecture.md#2-project-structure-monorepo]

**Publishing Module Organization:**
```
packages/backend/src/modules/sessions/
├── entities/
│   ├── session.entity.ts (extend existing)
│   └── session-status-history.entity.ts (new)
├── services/
│   ├── session-status.service.ts (new)
│   ├── content-validation.service.ts (new)
│   └── publishing-automation.service.ts (new)
├── schedulers/
│   ├── session-completion.scheduler.ts (new)
│   └── content-validation.scheduler.ts (new)
└── controllers/
    └── session-admin.controller.ts (extend existing)
```

### Integration with Manual Status Updates
[Source: Story 3.2 status transition patterns]

**Status Transition Validation:**
- Implement shared validation service used by both manual and automated workflows
- Ensure automated logic respects manual status change business rules
- Prevent conflicts between manual and automated status updates
- Provide clear feedback when automated rules prevent user actions

### Testing Requirements
[Source: docs/architecture.md and NestJS testing patterns]

**Testing Framework:** Jest with NestJS testing utilities
**Test Location:** `packages/backend/src/modules/sessions/__tests__/`
**Test Requirements:**
- Unit tests for all service methods
- Integration tests for scheduled task execution
- E2E tests for status transition workflows
- Mock external dependencies (database, timers)
- Test timezone handling edge cases

### Background Job Architecture
**Job Processing:**
- Use NestJS scheduled tasks (@Cron decorators)
- Implement job queuing for high-volume processing
- Add retry mechanisms for failed automated operations
- Create job monitoring and alerting system

**Error Handling:**
- Comprehensive logging for all automated operations
- Alert system for critical automated workflow failures
- Graceful degradation when automated systems are unavailable
- Manual override capabilities for emergency situations

### Integration with Epic 2 Content Workflow
**Publishing Readiness Checks:**
1. Session basic information complete (title, description, times)
2. Location and trainer assigned
3. AI-generated promotional content integrated
4. Content validation rules passed
5. No scheduling conflicts detected

### Success Criteria
The story is successful when the publishing system operates reliably with minimal manual intervention while maintaining data integrity and providing clear feedback when automated rules prevent certain actions.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-16 | 1.0 | Initial story creation for automated publishing logic | James Dev Agent |

## Dev Agent Record

### Agent Model Used
James Dev Agent powered by Sonnet 4 (claude-sonnet-4-20250514)

### Completion Notes List
- Implemented SessionCompletionScheduler with 15-minute automated completion checks
- Created PublishingAutomationService for business rule validation
- Added ContentValidationService for automated content validation
- Implemented WorkflowMonitoringService for system health monitoring
- Added comprehensive database transaction management in SessionStatusService
- Created automated audit trail through SessionStatusHistory entity
- Optimized performance with efficient database queries and background processing

### File List
- Backend: packages/backend/src/modules/sessions/schedulers/session-completion.scheduler.ts
- Backend: packages/backend/src/modules/sessions/schedulers/content-validation.scheduler.ts
- Backend: packages/backend/src/modules/sessions/services/publishing-automation.service.ts
- Backend: packages/backend/src/modules/sessions/services/content-validation.service.ts
- Backend: packages/backend/src/modules/sessions/services/workflow-monitoring.service.ts
- Backend: packages/backend/src/modules/sessions/services/session-status.service.ts
- Database: packages/backend/src/entities/session-status-history.entity.ts
- Tests: packages/backend/src/modules/sessions/__tests__/system-logic-integration.spec.ts

## QA Results
*To be populated by QA agent*