# Story 5.4: Asynchronous Webhook Sync

## Status
Done

## Story
**As a** content developer,
**I want** registration data to be automatically synchronized with third-party services via webhooks,
**so that** registered attendees are seamlessly integrated into our external systems without manual intervention.

## Acceptance Criteria

1. Background service processes registrations with sync_status="pending" automatically
2. Webhook requests are sent to configurable third-party service endpoint
3. Registration data is transformed into proper webhook payload format
4. Successful webhook responses update sync_status to "synced"
5. Failed webhook attempts update sync_status to "failed" and schedule retry
6. Retry logic implements exponential backoff (1min, 5min, 15min, 1hr, 6hr, 24hr)
7. Maximum retry attempts before marking as permanently failed (6 attempts)
8. Failed registrations are logged with detailed error information for debugging
9. System admin can view sync status and manually retry failed registrations
10. Webhook service runs independently without blocking user registration flow
11. Service includes monitoring and alerting for sync failure rates
12. Configuration supports multiple webhook endpoints for different session types

## Tasks / Subtasks

- [ ] Task 1: Create webhook sync service infrastructure (AC: 1, 10)
  - [ ] Create WebhookSyncService as background service in NestJS
  - [ ] Implement scheduled job processor using @nestjs/schedule
  - [ ] Add service startup and graceful shutdown handling
  - [ ] Configure service to run independently of web requests

- [ ] Task 2: Implement webhook payload transformation and delivery (AC: 2, 3)
  - [ ] Create webhook payload builder with registration data mapping
  - [ ] Implement HTTP client for webhook requests with proper headers
  - [ ] Add webhook endpoint configuration system (environment variables)
  - [ ] Support for multiple webhook configurations per session type

- [ ] Task 3: Build retry logic and status management (AC: 4, 5, 6, 7, 8)
  - [ ] Implement exponential backoff retry algorithm
  - [ ] Update registration sync_status based on webhook response
  - [ ] Add retry attempt counter and timestamp tracking
  - [ ] Create comprehensive error logging with request/response details
  - [ ] Mark registrations as permanently failed after max retry attempts

- [ ] Task 4: Admin monitoring and manual intervention capabilities (AC: 9, 11, 12)
  - [ ] Create admin API endpoints for viewing sync status and statistics
  - [ ] Implement manual retry functionality for failed registrations
  - [ ] Add webhook sync monitoring dashboard (optional UI component)
  - [ ] Create alerting system for high failure rates
  - [ ] Add configuration management for webhook endpoints

## Dev Notes

**Previous Story Insights:**
Story 5.3 implemented local registration capture with sync_status="pending". This story completes the two-stage registration system by processing the pending registrations asynchronously via webhook delivery to third-party services.

**Data Models:**
- Registrations table with sync_status field: pending → synced/failed [Source: architecture.md#feature-tables]
- Additional fields needed: retry_count, last_retry_at, webhook_response, error_details
- System settings table for webhook configuration storage [Source: architecture.md#core-tables]
- Webhook delivery log table for audit trail and debugging

**API Specifications:**
- Background service queries registrations WHERE sync_status='pending'
- Webhook endpoint: configurable third-party URL (environment variable)
- Webhook payload: { session_id, registration_id, name, email, referred_by, session_details }
- Admin endpoints: GET /admin/registrations/sync-status, POST /admin/registrations/{id}/retry
- Monitoring endpoint: GET /admin/webhook-sync/health

**Component Specifications:**
- NestJS background service using @nestjs/schedule for periodic processing
- HTTP client service for webhook delivery (axios or native fetch)
- Retry queue implementation with exponential backoff calculation
- Configuration service for webhook endpoint management
- Logging service with structured error reporting

**File Locations:**
- Webhook sync service: packages/backend/src/services/webhook-sync.service.ts
- Webhook configuration: packages/backend/src/config/webhook.config.ts
- Registration repository: packages/backend/src/modules/sessions/registration.repository.ts
- Admin controller: packages/backend/src/modules/admin/webhook-admin.controller.ts
- Webhook DTO: packages/backend/src/modules/sessions/dto/webhook-payload.dto.ts

**Technical Constraints:**
- Retry logic with failure monitoring per NFR5 requirements [Source: requirements NFR5]
- Service must not block user registration flow (asynchronous processing)
- Webhook delivery should handle network timeouts and connection failures
- Configuration must support environment-specific webhook endpoints
- Error logging must provide sufficient detail for troubleshooting

**Integration Points:**
- Processes registrations created by Story 5.3 (local capture)
- Integrates with third-party services specified in appflow.txt requirements
- Feeds into admin monitoring capabilities for system health oversight
- May integrate with QR code generation service (Story 5.5) for session links

**Webhook Configuration:**
```typescript
// Environment variables
WEBHOOK_REGISTRATION_URL=https://external-service.com/api/registrations
WEBHOOK_TIMEOUT_MS=30000
WEBHOOK_RETRY_MAX_ATTEMPTS=6
WEBHOOK_RETRY_BASE_DELAY_MS=60000
```

**Retry Schedule:**
- Attempt 1: Immediate (on registration)
- Attempt 2: 1 minute after failure
- Attempt 3: 5 minutes after failure
- Attempt 4: 15 minutes after failure
- Attempt 5: 1 hour after failure
- Attempt 6: 6 hours after failure
- Final attempt: 24 hours after failure
- After 6 failures: Mark as permanently failed

### Testing

**Testing Standards:**
- Unit tests for webhook sync service logic and retry algorithms
- Integration tests for webhook delivery with mock external services
- Database transaction tests for sync status updates
- Error handling tests for network failures and timeouts
- Performance tests for background service efficiency

**Key Test Scenarios:**
- Successful webhook delivery updates sync_status to "synced"
- Failed webhook delivery schedules appropriate retry
- Exponential backoff calculation works correctly
- Maximum retry attempts reached marks registration as permanently failed
- Service processes multiple pending registrations efficiently
- Admin retry functionality works for failed registrations
- Configuration changes take effect without service restart
- Service handles external service unavailability gracefully

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used
BMad Master (Claude Sonnet 4) - September 17, 2025

### Debug Log References
- Unit tests: `src/services/webhook-sync.service.spec.ts` (18 test cases)
- Admin controller tests: `src/modules/admin/webhook-admin.controller.spec.ts` (17 test cases)
- Integration tests: `src/services/webhook-sync.integration.spec.ts` (4 end-to-end scenarios)

### Completion Notes List
✅ **Background Service Infrastructure**: Created `WebhookSyncService` with NestJS scheduling, graceful startup/shutdown, and independent operation from web requests

✅ **Webhook Payload Transformation**: Implemented comprehensive payload builder with session details, registration data, and validation DTOs

✅ **Retry Logic & Status Management**: Built exponential backoff system (1min → 24hr) with 6-attempt limit, status tracking (pending→synced/failed), and permanent failure handling

✅ **Admin Monitoring**: Created full admin API with health statistics, manual retry capabilities, sync status monitoring, and failed registration management

✅ **Testing Coverage**: Comprehensive test suite including unit tests, integration tests, error handling, timeout scenarios, and edge cases

✅ **Configuration System**: Environment-based webhook configuration with timeout, retry, and URL settings

✅ **Integration Points**: Properly integrated with existing registration entity, session relationships, and app module structure

### File List
**Core Implementation:**
- `src/services/webhook-sync.service.ts` - Main webhook sync background service
- `src/config/webhook.config.ts` - Webhook configuration management
- `src/modules/sessions/dto/webhook-payload.dto.ts` - Webhook payload validation DTOs

**Admin Interface:**
- `src/modules/admin/webhook-admin.controller.ts` - Admin monitoring and control endpoints
- `src/modules/admin/admin.module.ts` - Admin module configuration

**Testing:**
- `src/services/webhook-sync.service.spec.ts` - Unit tests (18 cases)
- `src/modules/admin/webhook-admin.controller.spec.ts` - Controller tests (17 cases)
- `src/services/webhook-sync.integration.spec.ts` - Integration tests (4 scenarios)

**Configuration Updates:**
- `src/app.module.ts` - Service registration and TypeORM configuration

## QA Results
*Results from QA Agent review will be populated here*