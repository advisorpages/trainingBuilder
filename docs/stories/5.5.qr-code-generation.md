# Story 5.5: QR Code Generation

## Status
Draft

## Story
**As a** content developer,
**I want** QR codes automatically generated for published sessions,
**so that** attendees can easily access session information by scanning the code with their mobile devices.

## Acceptance Criteria

1. QR codes are automatically generated when sessions are published (status changed to "published")
2. QR codes link directly to the dynamic session page URL (/sessions/{session-id})
3. Generated QR codes are stored as image URLs in the sessions.qr_code_url field
4. QR code generation integrates with qr-cloud API service
5. QR codes are high-quality and scannable on both printed materials and digital displays
6. Failed QR code generation is logged and does not block session publishing
7. QR codes can be manually regenerated by content developers if needed
8. Generated QR codes include error correction to handle scanning in various conditions
9. QR code images are stored with permanent URLs accessible without authentication
10. System supports batch QR code generation for multiple sessions
11. QR codes are displayed in trainer dashboard and session management interfaces

## Tasks / Subtasks

- [ ] Task 1: Integrate qr-cloud API service (AC: 4, 5, 8)
  - [ ] Research and implement qr-cloud API integration based on provided documentation
  - [ ] Create QrCodeService for handling API requests and responses
  - [ ] Configure API authentication and endpoint settings
  - [ ] Implement error correction level settings for optimal scanning

- [ ] Task 2: Implement automatic QR generation on session publishing (AC: 1, 2, 3, 6)
  - [ ] Hook into session status change events (draft/review â†’ published)
  - [ ] Generate session page URL for QR code target
  - [ ] Call qr-cloud API to create QR code image
  - [ ] Store returned QR code URL in sessions.qr_code_url field
  - [ ] Add error handling that doesn't block publishing workflow

- [ ] Task 3: Manual QR code regeneration functionality (AC: 7, 10)
  - [ ] Create admin API endpoint for manual QR code generation
  - [ ] Add "Regenerate QR Code" button to session management interface
  - [ ] Support batch regeneration for multiple selected sessions
  - [ ] Provide user feedback for successful/failed generation attempts

- [ ] Task 4: Display QR codes in management interfaces (AC: 11)
  - [ ] Add QR code display to session detail views in admin interface
  - [ ] Include QR codes in trainer dashboard session information
  - [ ] Create QR code preview component for session management
  - [ ] Add QR code to session cards where appropriate
  - [ ] Provide download/copy functionality for QR code URLs

## Dev Notes

**Previous Story Insights:**
Stories 5.1-5.4 completed the public engagement system with homepage, session pages, and registration flow. QR codes provide the final piece by enabling offline-to-online conversion through physical materials and mobile scanning.

**Data Models:**
- Sessions table qr_code_url field stores generated QR code image URL [Source: architecture.md#feature-tables]
- QR codes target session page URLs created in Story 5.2
- System settings table can store qr-cloud API configuration [Source: architecture.md#core-tables]
- Session status field triggers QR generation when changed to "published"

**API Specifications:**
- qr-cloud API integration per technical assumptions [Source: prd technical-assumptions]
- API documentation available at Context7 library: /websites/qrcodes_at_api-documentation
- Generated QR codes link to: {base_url}/sessions/{session_id}
- Admin endpoints: POST /admin/sessions/{id}/generate-qr, POST /admin/sessions/batch-generate-qr
- QR code metadata: session_id, target_url, generation_timestamp, error_correction_level

**Component Specifications:**
- QrCodeService for external API integration
- Event handlers for session status changes
- Admin interface components for QR code display and management
- QR code preview component for session management interfaces
- Error handling and retry logic for API failures

**File Locations:**
- QR code service: packages/backend/src/services/qr-code.service.ts
- Session event handlers: packages/backend/src/modules/sessions/session.events.ts
- QR admin controller: packages/backend/src/modules/admin/qr-admin.controller.ts
- QR code component: packages/frontend/src/components/QrCodeDisplay.tsx
- QR configuration: packages/backend/src/config/qr-cloud.config.ts

**Technical Constraints:**
- QR codes must be accessible without authentication for public scanning
- Generation must not block critical session publishing workflow
- API integration follows third-party service patterns established in previous stories
- QR code URLs must be permanent and stable for printed materials
- Error correction level optimized for various scanning conditions

**Integration Points:**
- Session publishing workflow from Epic 3 (triggers QR generation)
- Dynamic session pages from Story 5.2 (QR code target URLs)
- Admin session management interfaces for QR code display
- Trainer dashboard from Epic 4 for QR code access
- Potential integration with trainer kit email notifications

**QR Code Configuration:**
```typescript
// Environment variables
QR_CLOUD_API_URL=https://api.qr-cloud.com/v1
QR_CLOUD_API_KEY=your_api_key_here
QR_CODE_ERROR_CORRECTION=M  // L, M, Q, H levels
QR_CODE_SIZE=300x300
QR_CODE_FORMAT=PNG
```

**qr-cloud API Integration Pattern:**
```typescript
// Expected API structure (to be confirmed with documentation)
POST /qr-codes
{
  "data": "https://yourdomain.com/sessions/123",
  "size": "300x300",
  "format": "png",
  "error_correction": "M"
}

Response:
{
  "qr_code_url": "https://qr-cloud.com/images/qr-abc123.png",
  "qr_code_id": "abc123",
  "target_url": "https://yourdomain.com/sessions/123"
}
```

### Testing

**Testing Standards:**
- Unit tests for QrCodeService and API integration logic
- Integration tests with mock qr-cloud API responses
- Event handler tests for session publishing triggers
- Admin interface tests for manual QR generation
- Error handling tests for API failures and network issues

**Key Test Scenarios:**
- Session publication automatically generates QR code
- Generated QR code URL is correctly stored in database
- Manual QR regeneration works for existing sessions
- Failed QR generation logs error but doesn't block publishing
- Batch QR generation processes multiple sessions correctly
- QR codes display properly in admin and trainer interfaces
- QR code links resolve to correct session pages
- API authentication and error handling work correctly

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-17 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*