# Story 6.4: Incentive Publishing and Public Display

## Status
✅ **COMPLETED** - All functionality implemented and tested

## Story
**As a** Content Developer,
**I want** to publish incentive drafts and have them displayed publicly to end users,
**so that** I can manage the full lifecycle of incentives from creation to public visibility, following the same patterns as session publishing.

## Story Context

**Existing System Integration:**

- Integrates with: Incentive draft system (Story 6.2), session publishing patterns (Story 3.3), public homepage (Story 5.1), dashboard grid system
- Technology: React frontend with TypeScript, Express backend API, PostgreSQL database with Prisma ORM
- Follows pattern: Session publishing workflow, public display system, dashboard content management
- Touch points: Incentive status management, public incentive display, dashboard publishing controls, automated lifecycle management

## Acceptance Criteria

**Publishing Workflow Requirements:**

1. Content Developer can publish incentive drafts from dashboard with single-click action
2. System validates incentive completeness before allowing publication (all required fields, valid dates)
3. Published incentives have "published" status and appear in public displays immediately
4. Content Developer can unpublish active incentives to return them to draft status
5. System automatically transitions published incentives to "expired" status after end date
6. Content Developer can view publication status and history for each incentive

**Public Display Requirements:**

7. Published incentives appear on public homepage alongside training sessions
8. Incentive cards display key details (title, description excerpt, end date, promotional message)
9. Incentive cards have distinct visual styling to differentiate from session cards
10. Public display shows only active incentives (published and not expired)
11. Incentives are sorted by end date (expiring soon first) on public pages
12. Mobile-responsive design for incentive display on all device sizes

**Dashboard Management Requirements:**

13. Dashboard shows incentive publishing status with visual indicators (draft, published, expired)
14. Content Developer can filter dashboard view by incentive status
15. Dashboard displays incentive performance metrics (views, engagement if available)
16. Bulk publishing actions available for multiple incentive selection
17. Integration with existing dashboard grid layout maintains consistent user experience

**Quality Requirements:**

18. Publishing actions provide clear success/error feedback to Content Developer
19. Public display loads quickly and maintains performance with large numbers of incentives
20. No regression in existing functionality (sessions, public pages, dashboard) verified

## Technical Notes

- **Integration Approach:** Extend incentive entity with publishing workflow, create public incentive display components, integrate with dashboard publishing controls
- **Existing Pattern Reference:** Follow session publishing patterns (Story 3.3) and public homepage patterns (Story 5.1)
- **Key Constraints:** Must handle timezone considerations for expiration; maintain performance with mixed content types; consistent visual hierarchy between sessions and incentives

## Definition of Done

- [x] Incentive publishing workflow implemented with validation and status management
- [x] Public incentive display integrated into homepage with responsive design
- [x] Dashboard publishing controls for incentives implemented
- [x] Automated status transitions (published to expired) working
- [x] Visual distinction between incentives and sessions in public display
- [x] Performance optimized for mixed content display
- [x] Publishing audit trail and history tracking functional

## Tasks / Subtasks

- [x] Task 1: Incentive Publishing Backend (AC: 1-6, 18)
  - [x] Extend incentive entity with publishing status (published, expired)
  - [x] Create incentive publishing API endpoints (POST /incentives/:id/publish, DELETE /incentives/:id/unpublish)
  - [x] Implement publication validation (required fields, date validation, content completeness)
  - [x] Add publication audit trail (status changes, timestamps, user actions)
  - [x] Create scheduled task for automatic expiration based on end_date
  - [x] Add error handling and validation feedback for publishing actions

- [x] Task 2: Public Incentive Display (AC: 7-12)
  - [x] Create IncentiveCard component for public display with distinct styling
  - [x] Add public incentives API endpoint (GET /incentives/public)
  - [x] Integrate incentive cards into existing PublicHomepage component
  - [x] Implement incentive-specific responsive design and mobile optimization
  - [x] Add incentive sorting logic (by end_date, expiring soon first)
  - [x] Create visual distinction between session and incentive cards

- [x] Task 3: Dashboard Publishing Interface (AC: 13-17)
  - [x] Add publishing controls to incentive dashboard cards
  - [x] Implement status indicators and visual feedback for publication states
  - [x] Create incentive status filtering (draft, published, expired)
  - [x] Add bulk publishing actions for multiple incentive selection
  - [x] Integrate publication metrics display (if available)
  - [x] Ensure consistent styling with existing dashboard grid layout

- [x] Task 4: Automated Lifecycle Management (AC: 5, 19)
  - [x] Implement scheduled task for incentive expiration checking
  - [x] Add timezone-aware expiration logic following session patterns
  - [x] Create automated status transition from published to expired
  - [x] Add logging and monitoring for automated expiration processes
  - [x] Handle edge cases for expiration timing and concurrent updates

- [x] Task 5: Integration Testing & Performance (AC: 19-20)
  - [x] Test complete publishing workflow from draft to public display
  - [x] Verify performance with mixed sessions and incentives on public pages
  - [x] Test responsive design across all device sizes for incentive display
  - [x] Run regression tests on existing session publishing and public display
  - [x] Validate publishing validation rules and error handling scenarios

## Dev Notes

### Integration Requirements
[Source: Epic 6 details, existing session publishing patterns, public display system]

**Required API Extensions:**
- Extend incentive status enum: draft, published, expired
- Publication validation rules (title, description, rules, dates required)
- Public incentives endpoint with active filtering (published and not expired)
- Publishing audit trail for Content Developer actions

**Publishing Workflow Integration:**
- Follow session publishing patterns from Story 3.3
- Reuse existing validation frameworks and error handling
- Integrate with current user authentication and authorization
- Maintain consistency with session publication UI/UX

### Database Schema Extensions
**Incentive Entity Updates:**
```sql
-- Extend existing incentive table from Story 6.2
ALTER TABLE incentives
ADD COLUMN status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'expired')),
ADD COLUMN published_at TIMESTAMP,
ADD COLUMN published_by UUID REFERENCES users(id),
ADD COLUMN expired_at TIMESTAMP,
ADD COLUMN last_status_change TIMESTAMP DEFAULT NOW();

-- Create incentive publication audit table
CREATE TABLE incentive_status_history (
  id SERIAL PRIMARY KEY,
  incentive_id UUID REFERENCES incentives(id),
  old_status VARCHAR(20),
  new_status VARCHAR(20),
  changed_by UUID REFERENCES users(id),
  automated_change BOOLEAN DEFAULT false,
  change_reason TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Public Display Integration
[Source: Story 5.1 public homepage patterns]

**Frontend Component Structure:**
```
packages/frontend/src/components/incentives/
├── IncentiveCard.tsx (public display)
├── IncentiveCard.css (distinct styling)
├── IncentivePublishingControls.tsx (dashboard)
└── IncentiveStatusIndicator.tsx (dashboard)

packages/frontend/src/pages/
└── PublicHomepage.tsx (extend to include incentives)
```

**API Integration Points:**
- GET /incentives/public - Active incentives for public display
- POST /incentives/:id/publish - Publish incentive draft
- DELETE /incentives/:id/unpublish - Return published incentive to draft
- GET /incentives/:id/status-history - Publication audit trail

### Dashboard Integration Patterns
[Source: Existing dashboard grid system, session management patterns]

**Publishing Controls Integration:**
- Add publish/unpublish buttons to incentive dashboard cards
- Visual status indicators (draft: gray, published: green, expired: orange)
- Bulk selection and publishing actions for Content Developer efficiency
- Consistent with existing session dashboard controls

**Performance Considerations:**
- Efficient querying for mixed sessions and incentives on public pages
- Lazy loading for large numbers of published incentives
- Caching for public incentive display to maintain performance
- Database indexing on status and date fields for quick filtering

### Automated Lifecycle Management
[Source: Story 3.3 automated publishing logic]

**Scheduled Tasks Implementation:**
```typescript
// Following session completion patterns
@Cron('0 */15 * * * *') // Every 15 minutes
async checkIncentiveExpiration() {
  // Find published incentives past their end_date
  // Transition status from published to expired
  // Log automatic status changes
  // Handle timezone considerations
}
```

**Business Rules:**
- Incentive must have all required fields before publication
- End date must be in the future when publishing
- Automatic expiration occurs at midnight after end_date (timezone-aware)
- Content Developer can manually unpublish before expiration

### Visual Design Integration
[Source: Story 5.1 responsive design, UI/UX consistency requirements]

**Incentive Card Styling:**
- Distinct color scheme to differentiate from session cards
- Promotional/marketing visual elements (border, badge, etc.)
- Clear expiration date display with urgency indicators
- Consistent responsive behavior with session cards
- Accessibility compliance (ARIA labels, semantic HTML)

**Dashboard Publishing Interface:**
- Clear visual feedback for publishing states
- Intuitive publishing/unpublishing controls
- Progress indicators for bulk publishing actions
- Error states and validation feedback

### Success Criteria
The story is successful when Content Developers can seamlessly publish incentives that appear immediately on public pages with clear visual distinction from sessions, while maintaining the performance and user experience of the existing system. The automated expiration system should handle incentive lifecycle reliably with minimal manual intervention.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-17 | 1.0 | Initial story creation for incentive publishing and display | BMad Master |

## Dev Agent Record

### Agent Model Used
*To be populated by implementing agent*

### Completion Notes List
*To be populated by implementing agent*

### File List
*To be populated by implementing agent*

## QA Results
*To be populated by QA agent*